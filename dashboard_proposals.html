<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –ü–æ–¥–∞–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            margin: 0;
            overflow: auto;
        }

        .container {
            max-width: 100%;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        header {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .nav-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 20px;
            display: inline-block;
            margin-right: 20px;
        }

        .header-icon {
            font-size: 28px;
        }

        .date-info {
            color: #666;
            font-size: 12px;
            display: inline-block;
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stats-block {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #8b5cf6;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #8b5cf6;
        }

        .table-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .table-container h3 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 14px;
            border-bottom: 2px solid #8b5cf6;
            padding-bottom: 8px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: #f5f3ff;
            position: sticky;
            top: 42px;
            z-index: 9;
        }

        th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #c4b5fd;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            color: #666;
            vertical-align: top;
        }

        tr:hover {
            background: #f5f3ff;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:nth-child(even):hover {
            background: #f5f3ff;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-review {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .description-cell {
            max-width: 400px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }

            .nav-buttons {
                justify-content: center;
            }

            h1 {
                font-size: 16px;
            }

            .stats-block {
                grid-template-columns: 1fr 1fr;
            }

            table {
                font-size: 10px;
            }

            th, td {
                padding: 6px;
            }

            .description-cell {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <div class="header-icon">üí°</div>
                <div>
                    <h1>–ü–æ–¥–∞–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</h1>
                    <span class="date-info">–û–Ω–æ–≤–ª–µ–Ω–æ: <span id="updateTime">--:--</span></span>
                </div>
            </div>
            <div class="nav-buttons">
                <a href="dashboard.html" class="nav-btn">üìä –í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</a>
                <a href="dashboard_employees.html" class="nav-btn">üë• –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</a>
                <a href="dashboard_defects.html" class="nav-btn">üî¥ –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</a>
                <a href="dashboard_safety.html" class="nav-btn">üõ°Ô∏è –û–ü</a>
                <a href="dashboard_power.html" class="nav-btn">üèÜ –ö–æ–º–∞–Ω–¥–∏</a>
                <a href="dashboard_announcements.html" class="nav-btn">üì¢ –û–≥–æ–ª–æ—à–µ–Ω–Ω—è</a>
                <button class="nav-btn active" disabled>üí° –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</button>
            </div>
        </header>

        <div class="content">
            <!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <div class="stats-block">
                <div class="stat-item">
                    <div class="stat-label">–í—Å—å–æ–≥–æ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</div>
                    <div class="stat-value" id="totalProposals">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ</div>
                    <div class="stat-value" id="reviewProposals">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</div>
                    <div class="stat-value" id="approvedProposals">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–¶—å–æ–≥–æ –º—ñ—Å—è—Ü—è</div>
                    <div class="stat-value" id="monthProposals">0</div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü—è –∑ –¥–∞–Ω–∏–º–∏ -->
            <div class="table-container">
                <h3>üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</h3>
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader">
                            <th>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="100%" style="text-align: center; padding: 20px;">
                                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // URL Google Apps Script –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby06zPv3izQ05E9O_gMEylaz3AM1Tl2SUZjwRnPPUyh_xHPETpyinUzkNP5lMQ8Ug5o/exec';

        window.addEventListener('load', () => {
            loadData();
            setInterval(loadData, 5 * 60 * 1000); // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω
            updateTime();
            setInterval(updateTime, 1000);
        });

        async function loadData() {
            try {
                console.log('üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...');
                
                // JSONP –¥–ª—è –æ–±—Ö–æ–¥—É CORS
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 9);
                    
                    window[callbackName] = function(data) {
                        console.log('‚úÖ –î–∞–Ω—ñ –æ—Ç—Ä–∏–º–∞–Ω–æ:', data);
                        console.log('üìä –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—è–¥–∫—ñ–≤:', data.tableData ? data.tableData.length : 0);
                        
                        if (data.error) {
                            console.error('‚ùå –ü–æ–º–∏–ª–∫–∞:', data.error);
                            showError();
                        } else if (!data.tableData || data.tableData.length === 0) {
                            console.warn('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü—è –ø–æ—Ä–æ–∂–Ω—è');
                            showError();
                        } else {
                            console.log('‚úÖ –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
                            updateTable(data.tableData);
                            updateStats(data.tableData);
                        }
                        
                        delete window[callbackName];
                        resolve();
                    };
                    
                    const script = document.createElement('script');
                    script.src = SCRIPT_URL + '?action=getProposalsData&callback=' + callbackName;
                    script.onerror = function() {
                        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
                        delete window[callbackName];
                        showSampleData(); // –ü–æ–∫–∞–∑—É—î–º–æ –¥–µ–º–æ-–¥–∞–Ω—ñ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
                        reject();
                    };
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞:', error);
                showSampleData();
            }
        }

        function updateTable(tableData) {
            if (!tableData || tableData.length === 0) {
                showError();
                return;
            }

            // –ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ - —Ü–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const headers = tableData[0];
            const rows = tableData.slice(1);

            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '';
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header;
                // –†–æ–±–∏–º–æ –æ–ø–∏—Å —à–∏—Ä—à–∏–º
                if (index === 3) {
                    th.style.width = '40%';
                }
                headerRow.appendChild(th);
            });

            // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            rows.forEach(row => {
                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏
                if (!row.some(cell => cell !== null && cell !== '')) {
                    return;
                }

                const tr = document.createElement('tr');
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    
                    // –°—Ç–∞—Ç—É—Å - –¥–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ–∑–æ–≤–∞–Ω–∏–π badge
                    if (index === 4 && cell) {
                        const badge = document.createElement('span');
                        badge.className = 'status-badge';
                        badge.textContent = cell;
                        
                        // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–ª–∞—Å –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Å—Ç–∞—Ç—É—Å—É
                        const statusText = cell.toString().toUpperCase();
                        if (statusText.includes('–†–û–ó–ì–õ–Ø–î')) {
                            badge.classList.add('status-review');
                        } else if (statusText.includes('–ó–ê–¢–í–ï–†–î') || statusText.includes('–ü–†–ò–ô–ù–Ø–¢')) {
                            badge.classList.add('status-approved');
                        } else if (statusText.includes('–í–Ü–î–•–ò–õ') || statusText.includes('–í–Ü–î–ú–û–í')) {
                            badge.classList.add('status-rejected');
                        } else if (statusText.includes('–í–ò–ö–û–ù–ê–ù')) {
                            badge.classList.add('status-completed');
                        }
                        
                        td.appendChild(badge);
                    }
                    // –û–ø–∏—Å - –¥–æ–¥–∞—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–ª–∞—Å
                    else if (index === 3) {
                        td.className = 'description-cell';
                        td.textContent = cell;
                    }
                    // –Ü–Ω—à—ñ –ø–æ–ª—è
                    else {
                        td.textContent = cell;
                    }
                    
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function updateStats(tableData) {
            if (!tableData || tableData.length <= 1) {
                return;
            }

            const rows = tableData.slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const validRows = rows.filter(row => row.some(cell => cell !== null && cell !== ''));
            
            // –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
            document.getElementById('totalProposals').textContent = validRows.length;

            // –ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ
            const reviewCount = validRows.filter(row => {
                const status = row[4] ? row[4].toString().toUpperCase() : '';
                return status.includes('–†–û–ó–ì–õ–Ø–î');
            }).length;
            document.getElementById('reviewProposals').textContent = reviewCount;

            // –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ
            const approvedCount = validRows.filter(row => {
                const status = row[4] ? row[4].toString().toUpperCase() : '';
                return status.includes('–ó–ê–¢–í–ï–†–î') || status.includes('–ü–†–ò–ô–ù–Ø–¢') || status.includes('–í–ò–ö–û–ù–ê–ù');
            }).length;
            document.getElementById('approvedProposals').textContent = approvedCount;

            // –ó–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthCount = validRows.filter(row => {
                const dateStr = row[0] ? row[0].toString() : '';
                if (dateStr) {
                    // –ü–∞—Ä—Å–∏–º–æ –¥–∞—Ç—É (—Ñ–æ—Ä–º–∞—Ç: 24.10.25)
                    const parts = dateStr.split('.');
                    if (parts.length === 3) {
                        const month = parseInt(parts[1]) - 1; // –ú—ñ—Å—è—Ü—ñ –≤ JS –≤—ñ–¥ 0
                        const year = 2000 + parseInt(parts[2]); // –î–æ–¥–∞—î–º–æ 2000 –¥–æ —Ä–æ–∫—É
                        return month === currentMonth && year === currentYear;
                    }
                }
                return false;
            }).length;
            document.getElementById('monthProposals').textContent = monthCount;
        }

        function showError() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 20px; color: #ef4444;">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ</td></tr>';
        }

        function showSampleData() {
            // –î–µ–º–æ-–¥–∞–Ω—ñ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É
            const sampleData = [
                ['–î–∞—Ç–∞ –ø–æ–¥–∞–Ω–Ω—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó', '–ü–Ü–ë –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞/–º–∞–π—Å—Ç—Ä–∞', '–î—ñ–ª—è–Ω–∫–∞', '–û–ø–∏—Å –ø–æ–¥–∞–Ω–æ—ó –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó', '–°—Ç–∞—Ç—É—Å'],
                ['24.10.25', '–ì–ª–∞–¥–∫–∏–π –Ñ.–í.', '–ê1', '–ù–∞ –∫—É–∑–æ–≤—ñ –ï—Ä–∏–¥–æ–Ω –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞–Ω—ñ –±–æ–∫–æ–≤–æ–≥–æ –±–æ—Ä—Ç–∞ —Ä—É—á–∫–∞ –∑–∞–º–∫–∞ –ø–∞–¥–∞—î –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –≤–Ω–∏–∑ —Ç–∞ –ø–æ—à–∫–æ–¥–∂—É—î –ë–ó–£ —Ç–∞ –∫–æ–ª–µ—Å—É', '–ù–ê –†–û–ó–ì–õ–Ø–î–Ü'],
                ['27.10.25', '–ì–ª–∞–¥–∫–∏–π –Ñ.–í.', '–ê1', '–ï–≤–∞–∫—É–∞—Ç–æ—Ä 706. –í –Ω–∞–¥—Ä–∞–º–Ω–∏–∫–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–≤–∞—Ä–∏—Ç—å –ø–æ–ø–µ—Ä–µ—á–∏–Ω—ã', '–ù–ê –†–û–ó–ì–õ–Ø–î–Ü']
            ];
            
            updateTable(sampleData);
            updateStats(sampleData);
        }

        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('updateTime').textContent = time;
        }
    </script>
</body>
</html>
